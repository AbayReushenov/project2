<html>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<head>
<title>Stored Procedure Overview</title>
<link rel="STYLESHEET" type="text/css" href="images/xpolecat.css">
<link rel="STYLESHEET" type="text/css" href="images/ie.content.css">
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;"><a href="toc.html"><img src="images/teamlib.gif" width="62" height="15" border="0" align="absmiddle"  alt="Team LiB"></a></div></td>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href="LiB0049.html"><img src="images/previous.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
<a href="LiB0051.html"><img src="images/next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</div></td></tr></table>
<br>
<div class="chapter">
<a name="ch09"></a>
<div class="section">
<h2 class="first-section-title"><a name="496"></a><a name="ch09lev1sec1"></a>Stored Procedure Overview</h2><p class="first-para">You can execute a stored procedure using the <span class="fixed">CALL</span> keyword in Oracle and DB2 (which is actually the SQL standard) or using the <span class="fixed">EXECUTE</span> (or the short form <span class="fixed">EXEC</span>) keyword in SQL Server or Access.</p>
<a name="497"></a><a name="IDX-204"></a>
<p class="para">Oracle also supports the <span class="fixed">EXECUTE <i class="emphasis">sp_name</i> (<i class="emphasis">param</i>)</span> syntax as a shorthand form for the following:</p>
<div class="informalexample">
<pre class="literallayout">
BEGIN
   <i class="emphasis">sp_name</i>(<i class="emphasis">param</i>);
END;
</pre>
</div>
<p class="para">Older versions of Oracle support only this syntax and don't support <span class="fixed">CALL</span>.</p>
<p class="para">To illustrate this, imagine you have a stored procedure called <span class="fixed">DeleteRow</span> in each of these databases, which takes as a parameter a numerical ID value corresponding to the row to be deleted. In Oracle or DB2, you could do the following to delete the row with an ID of <span class="fixed">5</span>:</p>
<div class="informalexample">
<pre class="literallayout">
CALL DeleteRow(5);
</pre>
</div>
<p class="para">In SQL Server or Access, you can use the following:</p>
<div class="informalexample">
<pre class="literallayout">
EXECUTE DeleteRow 5;
</pre>
</div>
<p class="para">Note that when calling SQL Server or Access stored procedures, you don't enclose the parameters in parentheses.</p>
<p class="para">As you can see, although the syntax does vary, the basic idea is the same&#8212;you provide the name of the stored procedure and the parameter(s) it requires. These parameters may also be output parameters; that is, the value will be set by the stored procedure and returned to the caller. In all cases, the meaning of a parameter is determined by its position in the list of parameters of a stored procedure, where multiple parameters are separated by commas. Which parameter goes in which position is determined by the definition of a stored procedure.</p>
<div class="section">
<h3 class="sect3-title">
<a name="498"></a><a name="ch09lev2sec1"></a>Creating a Stored Procedure</h3>
<p class="first-para">You create stored procedures using the SQL keyword combination <span class="fixed">CREATE PROCEDURE</span> (with the abbreviation or <span class="fixed">CREATE PROC</span> available in some RDBMSs). Again, the exact usage varies. In the following sections, you'll look at the various RDBMS syntaxes and see them in action with a simple <span class="fixed">InsertStudent</span> stored procedure that inserts a new student into the <span class="fixed">Student</span> table.</p>
<p class="para">The syntax for creating a stored procedure (supported by SQL Server, Oracle, DB2, and Access) is as follows:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE PROCEDURE <i class="emphasis">sp_name (parameter_list)</i>
AS
   <i class="emphasis">sp_body</i>;
<a name="499"></a><a name="IDX-205"></a>
</pre>
</div>
<p class="para">Although this much is standard, the individual RDBMSs each provide their own extensions to this and in particular their own keywords for programming code within a stored procedure. To show the basic syntax for creating stored procedures in the different RDBMSs, we'll run through a simple example that inserts a new row into the <span class="fixed">Student</span> table.</p>
<table border="0" cellspacing="0" cellpadding="0" class="note">
<tr>
<td valign="top" class="admon-check"></td><td valign="top" class="admon-title">Note </td><td valign="top" class="admon-body">
<p class="first-para">Oracle supports using the keyword <i class="emphasis"><span class="fixed">IS</span></i> instead of <i class="emphasis"><span class="fixed">AS</span></i>.</p>
</td>
</tr>
</table>
<div class="section">
<h4 class="sect4-title">
<a name="500"></a><a name="ch09lev3sec1"></a>SQL Server</h4>
<p class="first-para">The basic format for creating a SQL Server stored procedure is identical to the ANSI standard. The most important point to note is that the names of parameters in SQL Server must begin with the <span class="fixed">@</span> character. In fact (as you'll see shortly), this is true of variables in SQL Server generally.</p>
<div class="example">
<span class="example-title">CREATING A SIMPLE STORED PROCEDURE (SQL SERVER)</span><a name="501"></a>
<div class="formalbody">
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="Start example" border="0"></b></font></td>
</tr>
</table>
<p class="first-para">Enter this query and execute it against the <span class="fixed">InstantUniversity</span> database:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE PROCEDURE InsertStudent(@i_StudentID INT,
                                  @i_StudentName VARCHAR(50))
AS
BEGIN
   INSERT INTO Student(StudentID, Name)
   VALUES (@i_StudentID, @i_StudentName);
END;
</pre>
</div>
<p class="para">This creates a stored procedure called <span class="fixed">InsertStudent</span> with two input parameters, <span class="fixed">@i_StudentID</span> and <span class="fixed">@i_StudentName</span>. These parameters appear in the parameter list after the procedure name in the form <i class="emphasis"><span class="fixed">param_name data_type</span></i>. They allow you to pass values into the stored procedure, which you can then access in your SQL statements. In this case, you just insert these values straight into the <span class="fixed">Student</span> table.</p>
<p class="para">The body of the procedure can consist of a single statement, but you can also include it in a <span class="fixed">BEGIN...END</span> block, which allows you to create stored procedures consisting of multiple statements. You use this syntax here, even though it's not necessary because there's only one statement in the body of the procedure.</p>
<a name="502"></a><a name="IDX-206"></a>
<p class="para">Once you've created the procedure, you can execute it using this statement:</p>
<div class="informalexample">
<pre class="literallayout">
EXECUTE InsertStudent 500, 'Víteslav Novák';
</pre>
</div>
<p class="last-para">This will enter a row with the name <span class="fixed">'Víteslav Novák'</span> and a <span class="fixed">StudentID</span> of <span class="fixed">500</span> into the <span class="fixed">Student</span> table.</p>
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="End example" border="0"></b></font></td>
</tr>
</table>
<table class="BlankSpace" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td height="16"></td>
</tr>
</table>
</div>
</div>
</div>
<div class="section">
<h4 class="sect4-title">
<a name="503"></a><a name="ch09lev3sec2"></a>Oracle</h4>
<p class="first-para">The fundamental syntax for stored procedures in Oracle is similar to SQL Server and the ANSI standard:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE [OR REPLACE] PROCEDURE <i class="emphasis">sp_name (parameter_list)</i>
AS
BEGIN
   <i class="emphasis">sp_body</i>;
END;
/
</pre>
</div>
<p class="para">The first thing to notice here is the <span class="fixed">OR REPLACE</span> option, available when you're creating most types of database objects in Oracle. If this is specified, an existing stored procedure with the same name will be replaced when you create the new procedure. If this isn't specified and a procedure with the same name exists, an error will be thrown, and the new procedure won't be created.</p>
<p class="para">As with SQL Server, you include the SQL statements for the procedure in a <span class="fixed">BEGIN...END</span> block (although in the case of Oracle, this is mandatory, even if there's only one statement). The biggest difference in the basic syntax is in the way you use parameters. First, Oracle parameters don't start with an <span class="fixed">@</span> character; second, you need to explicitly declare the "direction" of your parameters&#8212;that is, whether they're input parameters that you simply pass into the procedure, output parameters that you use to return values to the application that called the procedure, or input/output parameters that both pass data into and out of the procedure.</p>
<p class="para">When you create a stored procedure, Oracle typically attempts to compile the procedure, even if it contains PL/SQL errors. A faulty procedure can't be executed, but it will still be created, so you'll need either to drop it before recompiling or to use the <span class="fixed">REPLACE</span> option. Also, notice that Oracle won't tell you what's <a name="504"></a><a name="IDX-207"></a>wrong with the procedure unless you specifically ask it to do so. To do this, just enter <span class="fixed">SHOW ERRORS</span> at the SQL*Plus command prompt.</p>
<div class="example">
<span class="example-title">CREATING A SIMPLE STORED PROCEDURE (ORACLE)</span><a name="505"></a>
<div class="formalbody">
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="Start example" border="0"></b></font></td>
</tr>
</table>
<p class="first-para">Enter this query into SQL*Plus:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE OR REPLACE PROCEDURE InsertStudent(
                                     i_StudentID   IN INT,
                                     i_StudentName IN VARCHAR)
AS
BEGIN
   INSERT INTO Student (StudentID, Name)
   VALUES (i_StudentID, i_StudentName);
END;
/
</pre>
</div>
<p class="para">Again, you create a stored procedure called <span class="fixed">InsertStudent</span> with two input parameters, <span class="fixed">i_StudentID</span>, and <span class="fixed">i_StudentName</span>. You mark the fact that these are input parameters by placing the <span class="fixed">IN</span> keyword between the parameter's name and its data type.</p>
<p class="para">You can execute your new procedure from SQL*Plus as follows:</p>
<div class="informalexample">
<pre class="literallayout">
CALL InsertStudent(500, 'Víteslav Novák');
</pre>
</div>
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="End example" border="0"></b></font></td>
</tr>
</table>
<table class="BlankSpace" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td height="16"></td>
</tr>
</table>
</div>
</div>
</div>
<div class="section">
<h4 class="sect4-title">
<a name="506"></a><a name="ch09lev3sec3"></a>DB2</h4>
<p class="first-para">And now for something completely different.... Although you use a SQL statement to create stored procedures in DB2, you can't just execute this statement in Command Center or a similar tool: You need to create and compile using the DB2 Development Center.</p>
<p class="para">Development Center can only compile stored procedures if a C++ compiler is installed on the machine on which it's running. On Windows, this means Microsoft Visual C++ must be installed; you'll also need to alter the <span class="fixed">Path</span>, <span class="fixed">Include</span>, <a name="507"></a><a name="IDX-208"></a>and <span class="fixed">Lib</span> system environment variables. Please consult the DB2 documentation for further details.</p>
<p class="para">To create a DB2 stored procedure, start by opening Development Center. You'll be invited to create a new project, as shown in <a class="internaljump" href="#ch09fig01">Figure 9-1</a>.</p>
<div class="figure">
<a name="508"></a><a name="ch09fig01"></a><span class="figuremediaobject"><a href="images/fig224%5F01%5F0%2Ejpg" NAME="IMG_18" target="_parent"><img src="images/fig224_01.jpg" height="237" width="350" alt="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 9-1: </span>Development Center's opening screen</span>
</div>
<p class="para">Click the Create Project button, and you'll be asked to give a name for the new project. Call it <i class="emphasis">InstantUniversitySprocs</i>, as shown in <a class="internaljump" href="#ch09fig02">Figure 9-2</a>.</p>
<div class="figure">
<a name="509"></a><a name="ch09fig02"></a><span class="figuremediaobject"><a href="images/fig225%5F01%5F0%2Ejpg" NAME="IMG_19" target="_parent"><img src="images/fig225_01.jpg" height="180" width="350" alt="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 9-2: </span>Naming the project</span>
</div>
<a name="510"></a><a name="IDX-209"></a>
<p class="para">The next task is to connect to the <span class="fixed">InstantUniversity</span> database. First, you have to specify whether you want to work offline or you want to connect to the DB2 server. Ensure that Online is selected and click Next, as shown in <a class="internaljump" href="#ch09fig03">Figure 9-3</a>.</p>
<div class="figure">
<a name="511"></a><a name="ch09fig03"></a><span class="figuremediaobject"><a href="images/fig225%5F02%5F0%2Ejpg" NAME="IMG_20" target="_parent"><img src="images/fig225_02.jpg" height="257" width="350" alt="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 9-3: </span>Specifying whether you want to work online</span>
</div>
<a name="512"></a><a name="IDX-210"></a>
<p class="para">You're now asked to supply details of the database you want to connect to, as shown in <a class="internaljump" href="#ch09fig04">Figure 9-4</a>.</p>
<div class="figure">
<a name="513"></a><a name="ch09fig04"></a><span class="figuremediaobject"><a href="images/fig226%5F01%5F0%2Ejpg" NAME="IMG_21" target="_parent"><img src="images/fig226_01.jpg" height="257" width="350" alt="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 9-4: </span>Setting up the connection details</span>
</div>
<p class="para">Enter the alias for the <span class="fixed">InstantUniversity</span> database (<span class="fixed">INSTUNI</span> in this case) and the ID and password of the user account you want to connect with, and then click Next. You're now asked whether you want to create a stored procedure or User-Defined Function (UDF) and whether you want to write it in SQL or Java, as shown in <a class="internaljump" href="#ch09fig05">Figure 9-5</a>.</p>
<div class="figure">
<a name="514"></a><a name="ch09fig05"></a><span class="figuremediaobject"><a href="images/fig227%5F01%5F0%2Ejpg" NAME="IMG_22" target="_parent"><img src="images/fig227_01.jpg" height="278" width="305" alt="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 9-5: </span>Choosing the type of object to create</span>
</div>
<a name="515"></a><a name="IDX-211"></a>
<p class="para">Java stored procedures are beyond the scope of the book, so make sure that both Stored Procedure and SQL are selected, and click OK. You're now requested to give a name to the procedure, as shown in <a class="internaljump" href="#ch09fig06">Figure 9-6</a>.</p>
<div class="figure">
<a name="516"></a><a name="ch09fig06"></a><span class="figuremediaobject"><a href="images/fig228%5F01%5F0%2Ejpg" NAME="IMG_23" target="_parent"><img src="images/fig228_01.jpg" height="257" width="350" alt="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 9-6: </span>Naming the stored procedure</span>
</div>
<a name="517"></a><a name="IDX-212"></a>
<p class="para">Replace the default name with <i class="emphasis">InsertStudent</i>, and click the Next button (you've left the name of the schema where it's stored as the prefix of the procedure name).</p>
<p class="para">DB2 provides a wizard that creates the SQL statements for the stored procedure, but this is a SQL book, so you're going to do this manually. DB2 allows stored procedures to return none, one, or more result sets; this first example doesn't return a result set, so select None for the Result Set field and then click Finish, as shown in <a class="internaljump" href="#ch09fig07">Figure 9-7</a>.</p>
<div class="figure">
<a name="518"></a><a name="ch09fig07"></a><span class="figuremediaobject"><a href="images/fig229%5F01%5F0%2Ejpg" NAME="IMG_24" target="_parent"><img src="images/fig229_01.jpg" height="257" width="350" alt="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 9-7: </span>Defining the stored procedure</span>
</div>
<a name="519"></a><a name="IDX-213"></a>
<p class="para">Back in the main Development Center window, open the stored procedure by double-clicking it. DB2 has added some default SQL code to create the procedure, as shown in <a class="internaljump" href="#ch09fig08">Figure 9-8</a>.</p>
<div class="figure">
<a name="520"></a><a name="ch09fig08"></a><span class="figuremediaobject"><a href="images/fig230%5F01%5F0%2Ejpg" NAME="IMG_25" target="_parent"><img src="images/fig230_01.jpg" height="280" width="350" alt="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 9-8: </span>The <i class="emphasis"><span class="fixed">InsertStudent</span></i> stored procedure</span>
</div>
<a name="521"></a><a name="IDX-214"></a>
<p class="para">You're going to create the procedure manually, so delete this code and replace it with the code for the stored procedure:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE PROCEDURE DB2ADMIN.InsertStudent (
       i_StudentID   INT,
       i_StudentName VARCHAR(50))
P1: BEGIN
   INSERT INTO Student (StudentID, Name)
   VALUES (i_StudentID, i_StudentName);
END P1
</pre>
</div>
<p class="para">Now that you've got this far, the SQL syntax for creating the procedure isn't too different from the standard:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE PROCEDURE <i class="emphasis">sp_name</i> (<i class="emphasis">parameter_list</i>)
<i class="emphasis">block_name</i>: BEGIN
   <i class="emphasis">sp_body</i>;
END <i class="emphasis">block_name</i>;
<a name="522"></a><a name="IDX-215"></a>
</pre>
</div>
<p class="para">DB2 can optionally use labels for <span class="fixed">BEGIN...END</span> blocks, so it's clear which block the <span class="fixed">END</span> keyword finishes.</p>
<p class="para">Save the procedure in the editor and return to the main Development Center window. Before you can use this stored procedure, you need to compile it. Do this by right-clicking the procedure name and selecting Build. Once the procedure has compiled, you can call it from Command Center using this statement:</p>
<div class="informalexample">
<pre class="literallayout">
CALL InsertStudent(500, 'Víteslav Novák');
</pre>
</div>
<p class="last-para">This will enter a row with the specified values into the <span class="fixed">Student</span> table.</p>
</div>
<div class="section">
<h4 class="sect4-title">
<a name="523"></a><a name="ch09lev3sec4"></a>Access</h4>
<p class="first-para">Access doesn't support stored procedures as such, but it does allow you to create stored queries using the <span class="fixed">CREATE PROCEDURE</span> syntax. You can use stored queries like stored procedures or (if they return a result set) like views, so if you have a query named <span class="fixed">GetStudents</span> that returns a result set of all the students in the database, you call it just as you call a view:</p>
<div class="informalexample">
<pre class="literallayout">
SELECT StudentID, Name FROM GetStudents;
</pre>
</div>
<p class="para">Or you could call it as you would a stored procedure in SQL Server:</p>
<div class="informalexample">
<pre class="literallayout">
EXECUTE GetStudents;
</pre>
</div>
<p class="para">You should be aware of a couple more restrictions with Access queries. First, queries can only contain one SQL statement, so you can't perform two actions with a query. Second, you can't enter the <span class="fixed">CREATE PROCEDURE</span> statement directly into the SQL window in Access. When you create an Access query, you're effectively executing a <span class="fixed">CREATE PROCEDURE</span> statement behind the scenes, so you'll get an error if you type the statement manually into the SQL window. Because you want to show the full syntax, you'll print the whole <span class="fixed">CREATE PROCEDURE</span> statement. You can run this against the <span class="fixed">InstantUniversity</span> database from an application via a data-access technology such as ADO.</p>
<a name="524"></a><a name="IDX-216"></a>
<div class="example">
<span class="example-title">CREATING A SIMPLE STORED QUERY (ACCESS)</span><a name="525"></a>
<div class="formalbody">
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="Start example" border="0"></b></font></td>
</tr>
</table>
<p class="first-para">Execute this query against <span class="fixed">InstantUniversity</span>:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE PROCEDURE InsertStudent(@i_StudentID   INT,
                                  @i_StudentName VARCHAR(50))
AS
INSERT INTO Student (StudentID, Name)
VALUES (@i_StudentID, @i_StudentName);
</pre>
</div>
<p class="para">If you want to type this directly into the SQL window in Access, the syntax is as follows:</p>
<div class="informalexample">
<pre class="literallayout">
PARAMETERS @i_StudentID INT, @i_StudentName VARCHAR(50);
INSERT INTO Student (StudentID, Name)
VALUES (@i_StudentID, @i_StudentName);
</pre>
</div>
<p class="para">Otherwise, the syntax is identical to that for SQL Server stored procedures. As in SQL Server, Access parameter names are all preceded by the <span class="fixed">@</span> character. You can execute this query using the <span class="fixed">EXECUTE</span> keyword:</p>
<div class="informalexample">
<pre class="literallayout">
EXECUTE InsertStudent 500, 'Víteslav Novák';
</pre>
</div>
<p class="last-para">Note that you don't use parentheses for the arguments passed into an Access query.</p>
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="End example" border="0"></b></font></td>
</tr>
</table>
<table class="BlankSpace" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td height="16"></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="section">
<h3 class="sect3-title">
<a name="526"></a><a name="ch09lev2sec2"></a>Dropping and Modifying Stored Procedures</h3>
<p class="first-para">As with all database objects, you can delete an existing stored procedure using the <span class="fixed">DROP</span> command:</p>
<div class="informalexample">
<pre class="literallayout">
DROP PROCEDURE <i class="emphasis">ProcName</i>;
</pre>
</div>
<p class="para">This is supported by all platforms that support stored procedures.</p>
<p class="para">You can also modify a stored procedure using the <span class="fixed">ALTER PROCEDURE</span> statement in SQL Server and Oracle. In SQL Server, the <span class="fixed">ALTER PROCEDURE</span> statement has the same syntax as the <span class="fixed">CREATE PROCEDURE</span> statement and simply re-creates the stored procedure with the new specification. As with views, the <span class="fixed">ALTER PROCEDURE</span> statement in Oracle is used to recompile the view rather than to redefine it.</p>
<a name="527"></a><a name="IDX-217"></a>
</div>
<div class="section">
<h3 class="sect3-title">
<a name="528"></a><a name="ch09lev2sec3"></a>Creating and using Variables and Parameters</h3>
<p class="first-para">We mentioned earlier that the parameters to stored procedures can be of three types: input, output, or input/output. As you've seen in the previous examples, input parameters are used solely to pass information to the procedure, for example, to determine which rows to retrieve, update, and so on. On some systems, stored procedures can also return values, in the same way that functions in programming languages (or indeed, SQL UDFs) return values. However, before you look at output parameters and return values in detail, you need to understand how to create and use variables in SQL code.</p>
<div class="section">
<h4 class="sect4-title">
<a name="529"></a><a name="ch09lev3sec5"></a>SQL Variables</h4>
<p class="first-para">Variables in SQL are similar to variables in other languages. That's to say that they're basically a means of storing a value in memory, referenced by a unique name. For example, you could have a variable called <span class="fixed">MyVar</span> that you assign a value to and then use it to send data to a stored procedure via a parameter. Alternatively, you might get a value from a stored procedure into a variable, either via an output parameter or a return value.</p>
<p class="para">As you've seen, you can use literal values as parameters when calling a stored procedure. However, you'll often need to use variables to store and retrieve data values from parameters, and even if you don't you may have to use variables inside a stored procedure.</p>
<p class="para">Note that Access doesn't support variables (apart from input parameters).</p>
<p class="para">SQL variables are simply defined names for a specific item of data. Like parameters, variables must have an <span class="fixed">@</span> symbol prefix in SQL Server and MySQL, but not in Oracle or DB2.</p>
<div class="section">
<h5 class="sect5-title">
<a name="530"></a><a name="ch09lev4sec1"></a>Declaring Variables</h5>
<p class="first-para">Variables are declared using the <span class="fixed">DECLARE</span> keyword:</p>
<div class="informalexample">
<pre class="literallayout">
DECLARE <i class="emphasis">var_name var_type</i>(<i class="emphasis">length</i>);
</pre>
</div>
<p class="para">You can also declare several variables of the same type simultaneously:</p>
<div class="informalexample">
<pre class="literallayout">
DECLARE var1_name, var2_name, var3_name var_type(length);
</pre>
</div>
<p class="para">The <i class="emphasis"><span class="fixed">var_type</span></i> can be any of the data types defined in your RDBMS, such as <span class="fixed">int</span> or <span class="fixed">nvarchar</span>; <i class="emphasis"><span class="fixed">length</span></i> is an optional integer value saying how much storage to allocate (that is, the width of the column). You can also specify a scale (the number of decimal places) to use for floating-point values. Typically, you'll be declaring variable types that match column data types in tables that are <a name="531"></a><a name="IDX-218"></a>manipulated by the stored procedure you're calling, so you'll often have to take this into account in both <i class="emphasis"><span class="fixed">var_type</span></i> and <i class="emphasis"><span class="fixed">length</span></i>. Also, some values won't be meaningful for the data type in use, and some variable types don't require a value for this parameter (including <span class="fixed">int</span>), so you need to be careful here.</p>
<p class="para">In DB2, variables can only be declared within a <span class="fixed">BEGIN...END</span> block. When these blocks are used in dynamic SQL (that is, not in a stored procedure or function), you need to specify the <span class="fixed">ATOMIC</span> keyword:</p>
<div class="informalexample">
<pre class="literallayout">
BEGIN ATOMIC
   DECLARE myvar VARCHAR(50);
   -- Assign and use variable
END;
</pre>
</div>
<p class="para">We'll discuss the atomic properties when you look at transactions in <a href="LiB0056.html#633" target="_parent" class="chapterjump">Chapter 10</a>, "Transactions."</p>
<p class="para">If you're entering a compound statement such as this via DB2's Command Center, you need to change the character that marks the end of the statement from the default semicolon, or Command Center won't pass the complete statement to DB2 (it will only reach the first semicolon in the embedded statements). You can change the statement termination character on the General tab of the Tools <font face="wingdings">Ø</font> Tools Settings menu, as shown in <a class="internaljump" href="#ch09fig09">Figure 9-9</a>.</p>
<div class="figure">
<a name="532"></a><a name="ch09fig09"></a><span class="figuremediaobject"><a href="images/fig234%5F01%5F0%2Ejpg" NAME="IMG_26" target="_parent"><img src="images/fig234_01.jpg" height="228" width="350" alt="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 9-9: </span>The Tools Settings dialog box</span>
</div>
<a name="533"></a><a name="IDX-219"></a>
<p class="para">In Oracle, the <span class="fixed">DECLARE</span> statement is placed before the <span class="fixed">BEGIN</span> block. Any variables you want to use in the compound statement must be declared in this <span class="fixed">DECLARE</span> statement:</p>
<div class="informalexample">
<pre class="literallayout">
DECLARE
   myvar      VARCHAR(50);
   myothervar INT;
BEGIN
   -- Assign and use variables
END;
/
</pre>
</div>
<p class="para">As well as RDBMS-specific types, you can also use the special type of <span class="fixed">CURSOR</span>:</p>
<div class="informalexample">
<pre class="literallayout">
DECLARE <i class="emphasis">cursor_name</i> CURSOR FOR <i class="emphasis">cursor_spec</i>;
</pre>
</div>
<p class="last-para">This is a special case of variable, used to loop through rows returned from a query. Cursors are used by Oracle and DB2 to return result sets from a stored procedure, and you'll learn about them in more depth a little later.</p>
</div>
<div class="section">
<h5 class="sect5-title">
<a name="534"></a><a name="ch09lev4sec2"></a>Assigning Variables</h5>
<p class="first-para">Once you've declared a variable, you may need to assign a value to it prior to a procedure call. The syntax for this varies between RDBMSs. In SQL Server you assign values with the <span class="fixed">SET</span> or <span class="fixed">SELECT</span> keywords:</p>
<div class="informalexample">
<pre class="literallayout">
SET @<i class="emphasis">VarName</i> = <i class="emphasis">Value</i>;
SELECT @<i class="emphasis">VarName</i> = <i class="emphasis">Value</i>;
</pre>
</div>
<p class="para">Here <i class="emphasis"><span class="fixed">VarName</span></i> is the name of the variable, and <i class="emphasis"><span class="fixed">Value</span></i> is a literal value of the appropriate type or some expression that evaluates to a value of the appropriate type. This could include a <span class="fixed">SELECT</span> statement used as a subquery.</p>
<p class="para">Variables can also have values assigned to them in other ways, such as via functions or subqueries.</p>
<p class="para">In MySQL and DB2, you can also use <span class="fixed">SET</span> in the same way as previously described (though DB2 doesn't use the <span class="fixed">@</span> character for variable names). However, MySQL also allows values to be assigned to variables in any SQL statement although this requires using the <span class="fixed">:=</span> assignment operator rather than <span class="fixed">=</span> because <span class="fixed">= </span>is used as a comparison operator outside of <span class="fixed">SET</span> statements. For example:</p>
<div class="informalexample">
<pre class="literallayout">
@<i class="emphasis">VarName</i> := <i class="emphasis">Value</i>;
<a name="535"></a><a name="IDX-220"></a>
</pre>
</div>
<p class="para">Oracle also uses this syntax (although you don't need <span class="fixed">@</span>):</p>
<div class="informalexample">
<pre class="literallayout">
<i class="emphasis">VarName</i> := <i class="emphasis">Value</i>;
</pre>
</div>
<p class="para">Oracle and DB2 have a special syntax for storing values from a <span class="fixed">SELECT</span> query into variables:</p>
<div class="informalexample">
<pre class="literallayout">
SELECT Name FROM Professor INTO ProfessorName
WHERE ProfessorID = 1;
</pre>
</div>
<p class="para">This will store the name of the professor with an ID of <span class="fixed">1</span> into the <span class="fixed">ProfessorName</span> variable.</p>
<p class="para">Once you have a value in a variable, you can then go ahead and use the value in subsequent SQL statements in the same batch of commands. This is important in the body of stored procedures. Effectively, what happens with parameters is that the parameter is a variable declared and assigned when the stored procedure executes. For example, if you had a <span class="fixed">DeleteStudent</span> stored procedure that deleted a single row from the <span class="fixed">Student</span> table according to an ID parameter, you could define the stored procedure as follows (with minor variations for the different platforms):</p>
<div class="informalexample">
<pre class="literallayout">
CREATE PROCEDURE DeleteStudent(i_StudentID INT)
AS
BEGIN
   DELETE FROM Student
   WHERE StudentID = i_StudentID;
END;
</pre>
</div>
<p class="last-para">Here the parameter <span class="fixed">i_StudentID</span> is in fact a variable, which is subsequently used in the <span class="fixed">WHERE</span> clause to select the correct name. This applies to all RDBMSs with stored procedures.</p>
</div>
</div>
<div class="section">
<h4 class="sect4-title">
<a name="536"></a><a name="ch09lev3sec6"></a>Default Parameter Values</h4>
<p class="first-para">If you want, you can provide a default value for a parameter. If a value isn't provided for that parameter, the default value will be used. You do this in SQL Server and Access by adding the default value after the parameter's data type, separated by an equals sign. For example, to create an <span class="fixed">InsertProfessor</span> procedure that uses a default value of <span class="fixed">'Prof. A.N. Other'</span> for the professor's name if one isn't supplied, use this:</p>
<a name="537"></a><a name="IDX-221"></a>
<div class="informalexample">
<pre class="literallayout">
CREATE PROCEDURE InsertProfessor (
   @i_ProfID INT,
   @i_ProfName VARCHAR(50) = 'Prof. A.N. Other')
AS
   INSERT INTO Professor (ProfessorID, Name)
   VALUES (@i_ProfID, @i_ProfName);
</pre>
</div>
<p class="para">In Oracle, you use the keyword <span class="fixed">DEFAULT</span> instead of an equals sign:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE OR REPLACE PROCEDURE InsertProfessor (i_ProfID IN INT,
   i_ProfName IN VARCHAR DEFAULT 'Prof. A.N. Other')
AS
BEGIN
   INSERT INTO Professor (ProfessorID, Name)
   VALUES (i_ProfID, i_ProfName);
END;
/
</pre>
</div>
<p class="para">You can then call this procedure as usual.</p>
<table border="0" cellspacing="0" cellpadding="0" class="note">
<tr>
<td valign="top" class="admon-check"></td><td valign="top" class="admon-title">Note </td><td valign="top" class="admon-body">
<p class="first-para">DB2 doesn't support default parameter values.</p>
</td>
</tr>
</table>
</div>
<div class="section">
<h4 class="sect4-title">
<a name="538"></a><a name="ch09lev3sec7"></a>Using Output Parameters</h4>
<p class="first-para">Now that you know how to use variables, you can look in more detail at output parameters. Output parameters are used to pass data back from the procedure to the calling application. The parameter is assigned a value within the body of the procedure, and this value is returned to the application.</p>
<p class="para">Return values for procedures do exist on some platforms (although not Oracle or Access) as well as output parameters, but they can only be integers and are used for returning the error status of the operation.</p>
<p class="para">For example, suppose you have a stored procedure that returns the name of a student given an ID. You would pass the ID in as an input parameter and return the name as an output parameter. To show how output parameters work, let's see how you implement this in the various RDBMSs.</p>
<div class="section">
<h5 class="sect5-title">
<a name="539"></a><a name="ch09lev4sec3"></a>SQL Server</h5>
<p class="first-para">Output parameters in SQL Server are marked by adding the keyword <span class="fixed">OUT</span> or <span class="fixed">OUTPUT</span> after the parameter's data type. For example:</p>
<div class="informalexample">
<pre class="literallayout">
(@OutputParamName INT OUTPUT)
<a name="540"></a><a name="IDX-222"></a>
</pre>
</div>
<div class="example">
<span class="example-title">USING OUTPUT PARAMETERS (SQL SERVER)</span><a name="541"></a>
<div class="formalbody">
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="Start example" border="0"></b></font></td>
</tr>
</table>
<p class="first-para">Create the following stored procedure:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE PROCEDURE GetStudentName(
                         @i_StudentID   INT,
                         @o_StudentName VARCHAR(50) OUTPUT)
AS
BEGIN
   SET @o_StudentName = (SELECT Name FROM Student
                           WHERE StudentID = @i_StudentID);
END;
</pre>
</div>
<p class="para">Here you retrieve the name of a student given the student's ID number. This ID is passed into the stored procedure as an input parameter. You return the name from the procedure as an output parameter called <span class="fixed">@o_StudentName</span>. You set the value of this parameter using a subquery in the <span class="fixed">SET</span> statement, selecting the name of the appropriate student.</p>
<p class="para">Once this procedure has been compiled, you can execute it by entering the following statements into Query Analyzer:</p>
<div class="informalexample">
<pre class="literallayout">
DECLARE @StudentName varchar(50);
EXEC GetStudentName 4, @StudentName OUTPUT;
PRINT @StudentName;
</pre>
</div>
<p class="para">Here you declare the variable that you'll use to store the output parameter and then use the <span class="fixed">EXEC</span> keyword to execute the parameter. Notice that you have to specify the <span class="fixed">OUTPUT</span> keyword when you call the procedure, as well as when you define it. Finally, you print the value of the <span class="fixed">@StudentName</span> variable using Query Analyzer's <span class="fixed">PRINT</span> function:</p>
<div class="informalexample">
<pre class="literallayout">
   Bruce Lee
</pre>
</div>
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="End example" border="0"></b></font></td>
</tr>
</table>
<table class="BlankSpace" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td height="16"></td>
</tr>
</table>
</div>
</div>
</div>
<div class="section">
<h5 class="sect5-title">
<a name="542"></a><a name="ch09lev4sec4"></a>Oracle</h5>
<p class="first-para">For output parameters in Oracle, you just replace the <span class="fixed">IN</span> keyword with <span class="fixed">OUT</span>:</p>
<div class="informalexample">
<pre class="literallayout">
(<i class="emphasis">OutputParamName</i> OUT INT)
<a name="543"></a><a name="IDX-223"></a>
</pre>
</div>
<div class="example">
<span class="example-title">USING OUTPUT PARAMETERS (ORACLE)</span><a name="544"></a>
<div class="formalbody">
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="Start example" border="0"></b></font></td>
</tr>
</table>
<p class="first-para">Create the <span class="fixed">GetStudentName</span> procedure by entering this code into SQL*Plus:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE OR REPLACE PROCEDURE GetStudentName(
                                  i_StudentID   IN  INT,
                                  o_StudentName OUT VARCHAR)
AS
BEGIN
   SELECT Name INTO o_StudentName FROM Student
   WHERE StudentID = i_StudentID;
END;
/
</pre>
</div>
<p class="para">Here you use Oracle's <span class="fixed">SELECT INTO</span> syntax to store the name of the student with the specified ID into your output parameter, <span class="fixed">o_StudentName</span>. When the procedure is executed, this value will be available to the application. You can execute the stored procedure and print the value of <span class="fixed">o_StudentName</span> in SQL*Plus using the following lines:</p>
<div class="informalexample">
<pre class="literallayout">
SET SERVEROUT ON
DECLARE
   StudentName VARCHAR(50);
BEGIN
   GetStudentName(3, StudentName);
   dbms_output.put_line(StudentName);
END;
/
</pre>
</div>
<p class="para">The first line here, <span class="fixed">SET SERVEROUT ON</span>, is a SQL*Plus command that allows you to print output to SQL*Plus; if you don't set <span class="fixed">SERVEROUT</span> to on, you won't be able to display the value of your output parameter after the procedure has executed.</p>
<p class="para">Next, you declare a variable called <span class="fixed">StudentName</span> to hold the output value and pass this into the stored procedure. Notice that you don't use the <span class="fixed">CALL</span> keyword when calling a stored procedure from inside a <span class="fixed">BEGIN</span> block. Finally, you display the value by calling SQL*Plus's <span class="fixed">dbms_output.put_line()</span> function:</p>
<div class="informalexample">
<pre class="literallayout">
   Emily Scarlett
</pre>
</div>
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="End example" border="0"></b></font></td>
</tr>
</table>
<table class="BlankSpace" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td height="16"></td>
</tr>
</table>
</div>
</div>
<a name="545"></a><a name="IDX-224"></a>
</div>
<div class="section">
<h5 class="sect5-title">
<a name="546"></a><a name="ch09lev4sec5"></a>DB2</h5>
<p class="first-para">In DB2, you place the <span class="fixed">OUT</span> keyword before the parameter name:</p>
<div class="informalexample">
<pre class="literallayout">
(OUT <i class="emphasis">OutputParamName</i> INT)
</pre>
</div>
<div class="example">
<span class="example-title">USING OUTPUT PARAMETERS (DB2)</span><a name="547"></a>
<div class="formalbody">
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="Start example" border="0"></b></font></td>
</tr>
</table>
<p class="first-para">The DB2 code for creating your <span class="fixed">GetStudentName</span> procedure looks like this:</p>
<div class="informalexample">
<pre class="literallayout">
CREATE PROCEDURE GetStudentName(i_StudentID INT,
                               OUT o_StudentName VARCHAR(50))
P1: BEGIN
   SET o_StudentName = (SELECT Name FROM Student
                          WHERE StudentID = i_StudentID);
END P1
</pre>
</div>
<p class="para">Create a new stored procedure in the <span class="fixed">InstantUniversitySprocs</span> project in Development Center, enter this code, and build the procedure.</p>
<p class="para">In DB2, you can set a variable to a value retrieved from a query using the normal <span class="fixed">SET</span> syntax, assigning the result of the <span class="fixed">SELECT</span> query to the variable:</p>
<div class="informalexample">
<pre class="literallayout">
SET o_StudentName = (SELECT Name FROM Student
                       WHERE StudentID = i_StudentID);
</pre>
</div>
<p class="para">To execute the procedure in DB2 Command Center, you just need to enter one line:</p>
<div class="informalexample">
<pre class="literallayout">
CALL GetStudentName(2, ?);
</pre>
</div>
<p class="para">You use a question mark (<span class="fixed">?</span>) to represent the output parameter. After the procedure has been executed, Command Center displays the values of any output parameters:</p>
<a name="548"></a><a name="IDX-225"></a>
<div class="informalexample">
<pre class="literallayout">
   
Value of output parameters
   --------------------------
   Parameter Name  : O_STUDENTNAME
   Parameter Value : Gary Burton

   Return Status = 0
</pre>
</div>
<table class="BlueLine" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td bgcolor="000080" class="bluecell"><font size="2" face="Arial" color="010100"><b><img src="_.gif" width="1" height="2" alt="End example" border="0"></b></font></td>
</tr>
</table>
<table class="BlankSpace" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td height="16"></td>
</tr>
</table>
</div>
</div>
</div>
<div class="section">
<h5 class="sect5-title">
<a name="549"></a><a name="ch09lev4sec6"></a>Input/Output Parameters</h5>
<p class="first-para">As well as input and output parameters, DB2 and Oracle both support input/output parameters. These are parameters that you use both to feed data into the stored procedure and to return data from it. Input/output parameters are defined using the <span class="fixed">INOUT</span> keyword:</p>
<div class="informalexample">
<pre class="literallayout">
(INOUT <i class="emphasis">SomeParamName</i> INT)   -- DB2
(SomeParamName INOUT INT)   -- Oracle
</pre>
</div>
<p class="last-para">To use an input/output parameter, you need to declare and initialize a variable and then pass it into the stored procedure. The value of the parameter will then be modified within the stored procedure, and you can read the value of the variable again once the procedure has been executed.</p>
</div>
</div>
</div>
</div>
</div><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;"><a href="toc.html"><img src="images/teamlib.gif" width="62" height="15" border="0" align="absmiddle"  alt="Team LiB"></a></div></td>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href="LiB0049.html"><img src="images/previous.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
<a href="LiB0051.html"><img src="images/next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</div></td></tr></table>
</body></html>